# probpf

[English](README_en.md) | **ä¸­æ–‡**

ProBPF æ˜¯ä¸€ä¸ªåŸºäº eBPF å’Œ Go æ„å»ºçš„é«˜æ€§èƒ½ä¸»æœºç½‘ç»œæ´»åŠ¨ç›‘æ§å·¥å…·ã€‚å®ƒæä¾›å®æ—¶çš„ç½‘ç»œè¿æ¥è·Ÿè¸ªã€æµé‡ç»Ÿè®¡å’Œæµåˆ†æï¼Œå¹¶é€šè¿‡ç°ä»£åŒ–çš„ã€ç§»åŠ¨ç«¯å‹å¥½çš„ Web UI è¿›è¡Œå¯è§†åŒ–å±•ç¤ºã€‚

## åŠŸèƒ½ç‰¹æ€§

- **eBPF ç›‘æ§**: ä½¿ç”¨ XDP å’Œ TC é«˜æ•ˆè·Ÿè¸ª IPv4/IPv6 çš„ TCP å’Œ UDP æµé‡ã€‚
- **å®æ—¶ Web UI**:
  - **ä»ªè¡¨ç›˜**: æ¦‚è§ˆæ‰€æœ‰æ´»è·ƒå®¢æˆ·ç«¯ï¼Œæ”¯æŒæ’åºå’Œæœç´¢ã€‚
  - **å®¢æˆ·ç«¯è¯¦æƒ…**: æ·±å…¥æŸ¥çœ‹æ¯ä¸ªè¿æ¥ï¼ˆæµï¼‰çš„ç»Ÿè®¡ä¿¡æ¯ã€‚
  - **ä¼šè¯ä¸å…¨å±€ç»Ÿè®¡**: åˆ†åˆ«è·Ÿè¸ªå½“å‰ä¼šè¯å¸¦å®½ä½¿ç”¨é‡ä¸å†å²æ€»é‡ã€‚
  - **ç§»åŠ¨ç«¯ä¼˜åŒ–**: å…¨å“åº”å¼è®¾è®¡ï¼Œé€‚é…ç§»åŠ¨è®¾å¤‡çš„å¡ç‰‡è§†å›¾å’Œè§¦æ§æ“ä½œã€‚
  - **æ·±è‰²æ¨¡å¼**: æ”¯æŒè‡ªåŠ¨æˆ–æ‰‹åŠ¨åˆ‡æ¢æ˜æš—ä¸»é¢˜ã€‚
- **é«˜çº§æµé‡åˆ†æ**:
  - **æµæ—¶é•¿**: ç²¾ç¡®è·Ÿè¸ªè¿æ¥æŒç»­æ—¶é—´ã€‚
  - **åè®®è¿‡æ»¤**: æŒ‰åè®®ã€è¿œç¨‹ IP æˆ–ç«¯å£è¿›è¡Œè¿‡æ»¤ã€‚
  - **CIDR è¿‡æ»¤**: æ”¯æŒé€šè¿‡ `-lan` (è‡ªåŠ¨æ£€æµ‹) æˆ– `-cidr` (æ‰‹åŠ¨æŒ‡å®š) å¿½ç•¥ç‰¹å®šç½‘æ®µçš„æµé‡ï¼ˆå¦‚å†…ç½‘æµé‡ï¼‰ã€‚
- **èµ„æºé«˜æ•ˆ**:è‡ªåŠ¨è¿æ¥æ¸…ç†ï¼Œä½å¼€é”€çš„ eBPF æ¢é’ˆã€‚

## å‰ç½®è¦æ±‚

- Linux å†…æ ¸ >= 5.4 (å»ºè®®æ”¯æŒ BTF)
- LLVM/Clang ç”¨äº eBPF ç¼–è¯‘
- Go >= 1.21

## å®‰è£…

1. å…‹éš†ä»“åº“:

```bash
git clone https://github.com/kisy/probpf.git
cd probpf
```

2. å®‰è£…ä¾èµ– (Ubuntu/Debian):

```bash
apt-get install clang llvm libbpf-dev
```

3. ç¼–è¯‘é¡¹ç›® (ä½¿ç”¨æä¾›çš„è„šæœ¬):

```bash
./build.sh
```

è¯¥è„šæœ¬ä¼šè‡ªåŠ¨å¤„ç† eBPF ç”Ÿæˆä»¥åŠ AMD64 å’Œ ARM64 æ¶æ„çš„ Go ç¼–è¯‘ã€‚

## ä½¿ç”¨æ–¹æ³•

### Web UI æ¨¡å¼ (æ¨è)

å¯åŠ¨ç›‘æ§ä»£ç†å¹¶å¯ç”¨ Web UIï¼š

```bash
sudo ./bin/probpf-amd64 -i eth0 --listen :8000
```

è®¿é—® `http://<your-server-ip>:8000` æŸ¥çœ‹ä»ªè¡¨ç›˜ã€‚

### å±€åŸŸç½‘ç›‘æ§ä¸è¿‡æ»¤

é»˜è®¤æƒ…å†µä¸‹ï¼ŒProBPF ä¼šè‡ªåŠ¨å¿½ç•¥æœ¬åœ°å±€åŸŸç½‘æµé‡ã€‚

**å¼€å¯ LAN ç›‘æ§:**

```bash
sudo ./bin/probpf-amd64 -i eth0 --listen :8000 --lan
```

**è‡ªå®šä¹‰å¿½ç•¥ç½‘æ®µ:**
å¦‚æœä¸ä½¿ç”¨ `--lan`ï¼Œé€šè¿‡ `--cidr` æ‰‹åŠ¨æŒ‡å®šè¦å¿½ç•¥çš„ç½‘æ®µï¼ˆæ›¿ä»£è‡ªåŠ¨æ£€æµ‹ï¼‰ï¼š

```bash
sudo ./bin/probpf-amd64 -i eth0 --listen :8000 --cidr 192.168.0.0/16
```

## å‘½ä»¤è¡Œé€‰é¡¹

### åŸºç¡€é€‰é¡¹

| æ ‡å¿— | é•¿å‚æ•°               | æè¿°               | é»˜è®¤å€¼  |
| ---- | -------------------- | ------------------ | ------- |
| `-i` | `--interface`        | ç›‘æ§çš„ç½‘ç»œæ¥å£     | å¿…éœ€    |
| `-l` | `--listen`, `--http` | Web æœåŠ¡å™¨ç›‘å¬åœ°å€ | `:9092` |
| `-c` | `--config`           | é…ç½®æ–‡ä»¶è·¯å¾„       | -       |

### æ—¶é—´å‚æ•°ï¼ˆæ™ºèƒ½é»˜è®¤å€¼ï¼‰

| æ ‡å¿—  | é•¿å‚æ•°            | æè¿°                 | é»˜è®¤å€¼                   |
| ----- | ----------------- | -------------------- | ------------------------ |
| `-s`  | `--sync-interval` | æ•°æ®åŒæ­¥é—´éš”ï¼ˆç§’ï¼‰   | `1`                      |
| -     | `--flow-ttl`      | ä¸æ´»è·ƒæµé‡è¶…æ—¶ï¼ˆç§’ï¼‰ | `300`                    |
| `-gc` | `--gc-ttl`        | æ¸…ç†é—´éš”ï¼ˆç§’ï¼‰       | **è‡ªåŠ¨** = flow-ttl/5    |
| -     | `--client-ttl`    | å®¢æˆ·ç«¯ç¼“å­˜æ—¶é•¿ï¼ˆç§’ï¼‰ | **è‡ªåŠ¨** = flow-ttl\*0.4 |

> ğŸ’¡ **æ™ºèƒ½é»˜è®¤å€¼**: `--gc-ttl` å’Œ `--client-ttl` ä¼šæ ¹æ® `--flow-ttl` è‡ªåŠ¨è®¡ç®—ã€‚å¤§å¤šæ•°ç”¨æˆ·åªéœ€è®¾ç½® `--flow-ttl` å³å¯ã€‚

### è¿‡æ»¤é€‰é¡¹

| æ ‡å¿—     | é•¿å‚æ•°          | æè¿°                            | é»˜è®¤å€¼   |
| -------- | --------------- | ------------------------------- | -------- |
| `--lan`  | `--monitor-lan` | ç›‘æ§å±€åŸŸç½‘æµé‡ï¼ˆç¦ç”¨è¿‡æ»¤ï¼‰      | `false`  |
| `--cidr` | `--local-cidr`  | è¦å¿½ç•¥çš„æœ¬åœ° CIDRï¼ˆå¯å¤šæ¬¡æŒ‡å®šï¼‰ | è‡ªåŠ¨æ£€æµ‹ |

### é«˜çº§é€‰é¡¹

| æ ‡å¿— | é•¿å‚æ•°       | æè¿°                                      | é»˜è®¤å€¼ |
| ---- | ------------ | ----------------------------------------- | ------ |
| `-x` | `--xdp-mode` | XDP æ¨¡å¼ (auto, generic, driver, offload) | `auto` |

### ä½¿ç”¨ç¤ºä¾‹

**åŸºç¡€å¯åŠ¨ï¼ˆæ¨èï¼‰ï¼š**

```bash
sudo ./bin/probpf-amd64 -i eth0
# ä½¿ç”¨æ‰€æœ‰é»˜è®¤å€¼ï¼Œç®€å•å¿«é€Ÿ
```

**è‡ªå®šä¹‰æµé‡è¶…æ—¶ï¼š**

```bash
sudo ./bin/probpf-amd64 -i eth0 --flow-ttl 180
# gc-ttl è‡ªåŠ¨è®¾ä¸º 36 ç§’
# client-ttl è‡ªåŠ¨è®¾ä¸º 72 ç§’
```

**ä½èµ„æºè®¾å¤‡ï¼ˆå¦‚æ ‘è“æ´¾ï¼‰ï¼š**

```bash
sudo ./bin/probpf-amd64 -i eth0 --flow-ttl 120
# 2 åˆ†é’Ÿè¶…æ—¶ï¼Œå¿«é€Ÿé‡Šæ”¾å†…å­˜
```

## Prometheus ç›‘æ§

ProBPF å†…ç½® Prometheus metrics å¯¼å‡ºåŠŸèƒ½ï¼Œå¯ä¸ Grafana é›†æˆã€‚

### å¿«é€Ÿå¯åŠ¨

**å¯åŠ¨ Prometheus + Grafanaï¼š**

```bash
docker-compose up -d
```

**è®¿é—®ç›‘æ§é¢æ¿ï¼š**

- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000 (admin/admin)

### Metrics ç«¯ç‚¹

```bash
curl http://localhost:9092/metrics
```

### å¯¼å‡ºçš„æŒ‡æ ‡

**å…¨å±€æŒ‡æ ‡ï¼š**

- `probpf_global_download_bps` - æ€»ä¸‹è½½é€Ÿç‡
- `probpf_global_upload_bps` - æ€»ä¸Šä¼ é€Ÿç‡
- `probpf_global_active_connections` - æ´»è·ƒè¿æ¥æ•°
- `probpf_global_active_devices` - åœ¨çº¿è®¾å¤‡æ•°

**è®¾å¤‡çº§æŒ‡æ ‡ï¼š**

- `probpf_device_download_bps{mac, name}` - è®¾å¤‡ä¸‹è½½é€Ÿç‡
- `probpf_device_upload_bps{mac, name}` - è®¾å¤‡ä¸Šä¼ é€Ÿç‡
- `probpf_device_bytes_total{mac, name, direction}` - è®¾å¤‡æµé‡ç»Ÿè®¡

**åè®®ç»Ÿè®¡ï¼š**

- `probpf_protocol_bytes_total{protocol, direction}` - æŒ‰åè®®ç»Ÿè®¡æµé‡

### Grafana Dashboard

é¡¹ç›®åŒ…å«é¢„é…ç½®çš„ Grafana Dashboard (`grafana.json`)ï¼ŒåŒ…å«ï¼š

- å…¨å±€é€Ÿç‡ä»ªè¡¨ç›˜
- æµé‡è¶‹åŠ¿å›¾
- Top 10 è®¾å¤‡æ’è¡Œ
- åè®®åˆ†å¸ƒé¥¼å›¾
- Top 5 è®¾å¤‡è¶‹åŠ¿å¯¹æ¯”

## Web UI åŠŸèƒ½

- **å®¢æˆ·ç«¯åˆ—è¡¨**: æŸ¥çœ‹æ‰€æœ‰æ´»è·ƒ IP åŠå…¶å®æ—¶ä¸‹è½½/ä¸Šä¼ é€Ÿåº¦ã€‚
- **è¯¦æƒ…è§†å›¾**:
  - **ä¼šè¯ç»Ÿè®¡**: ç‹¬ç«‹çš„ä¼šè¯è®¡æ•°å™¨ (æµé‡/æ—¶é•¿)ï¼Œå¯é€šè¿‡ç‰¹å®šæŒ‰é’®é‡ç½®ã€‚
  - **å…¨å±€ç»Ÿè®¡**: å†å²æ€»æµé‡è®¡æ•°å™¨ã€‚
  - **æµåˆ—è¡¨**: æ‰€æœ‰æ´»è·ƒè¿æ¥çš„å®æ—¶åˆ—è¡¨ï¼ŒåŒ…å«åè®®ã€è¿œç¨‹ IP å’Œç«¯å£ã€‚
- **æ§åˆ¶**:
  - **è‡ªåŠ¨åˆ·æ–°**: æš‚åœ/æ¢å¤ å®æ—¶æ›´æ–°ã€‚
  - **ä¸»é¢˜**: åˆ‡æ¢ æ·±è‰²/æµ…è‰² æ¨¡å¼ã€‚
  - **IP ä¿¡æ¯**: é€‰æ‹©é¦–é€‰ IP åœ°ç†ä½ç½®æä¾›å•† (ipinfo.io, ipapi.is, censys.io ç­‰)ã€‚

## è®¸å¯è¯

GPL 2.0
